/** FCBKcomplete v2.8.9.3 is released under the MIT License <http://www.opensource.org/licenses/mit-license.php> */
(function(e){e.fn.fcbkcomplete=function(K){return this.queue(function(){function m(a,c,b,g,j){if(!q())return!1;g="bit-box"+(g?" locked":"");var h;h="";for(var k=0;32>k;k++){var m=Math.floor(61*Math.random());h+="0123456789ABCDEFGHIJKLMNOPQRSTUVWXTZabcdefghiklmnopqrstuvwxyz".substring(m,m+1)}m=document.createTextNode(p(a));k=e('<a class="closebutton" href="#"></a>');g=e('<li class="'+g+'" rel="'+c+'" id="pt_'+h+'"></li>').prepend(m).append(k);l.append(g);k.click(function(){w(e(this).parent("li"));
    return!1});b||(e("#"+r+"_annoninput").remove(),G(j),a=e('<option value="'+p(c,1)+'" id="opt_'+h+'" class="selected" selected="selected">'+p(a)+"</option>"),f.append(a),d.onselect&&x(d.onselect,a),f.change());l.children("li.bit-box.deleted").removeClass("deleted");t(1);return h}function w(a){if(!a.hasClass("locked")){a.fadeOut("fast");var c=a.attr("id");if(d.onremove){var b=c?e("#o"+c+""):f.children("option[value="+a.attr("rel")+"]");x(d.onremove,b)}c?e("#o"+c+"").remove():f.children('option[value="'+
    a.attr("rel")+'"]').remove();a.remove();f.change();y=0}}function G(a){var c=e('<li class="bit-input" id="'+r+'_annoninput">'),b=e('<input type="text" class="maininput" size="'+d.input_min_size+'" autocomplete="off">');0<d.input_tabindex&&b.attr("tabindex",d.input_tabindex);""!=d.input_name&&b.attr("name",d.input_name);l.append(c.append(b));b.focus(function(){z=!0;q()&&k.fadeIn("fast")});b.blur(function(){z=!1;A&&k.fadeOut("fast")});l.click(function(){0>d.input_min_size&&g.length&&H(s(b.val(),1));
    b.focus();g.length&&b.val().length>d.input_min_size?g.show():(t(1),k.children(".default").show())});b.keypress(function(a){if(a.keyCode==h.enter)return!1;a=d.input_min_size>b.val().length?d.input_min_size:b.val().length+1;b.attr("size",a).width(parseInt(b.css("font-size"))*a)});b.keyup(function(a){var c=s(b.val(),1);if(a.keyCode==h.backspace&&0==c.length&&(t(1),!l.children("li.bit-box:last").hasClass("locked"))){if(0==l.children("li.bit-box.deleted").length)return l.children("li.bit-box:last").addClass("deleted"),
    !1;if(y)return;y=1;l.children("li.bit-box.deleted").fadeOut("fast",function(){w(e(this));return!1})}a.keyCode!=h.downarrow&&(a.keyCode!=h.uparrow&&a.keyCode!=h.leftarrow&&a.keyCode!=h.rightarrow&&c.length>d.input_min_size)&&(H(c),k.children(".default").hide(),g.show())});d.oncreate&&x(d.oncreate,b);a&&setTimeout(function(){b.focus();k.children(".default").show()},1)}function B(a,c){g.html("");!d.cache&&null!=c&&n.clear();if(d.newel&&q()&&(g.children("li[fckb=1]").remove(),0!=a.length)){var b=e('<li rel="'+
    a+'" fckb="1">').html(p(a));g.prepend(b);u++}null!=c&&c.length&&e.each(c,function(a,c){n.set(s(c.key),s(c.value))});var h=d.maxshownitems<n.length()?d.maxshownitems:n.length(),l="";e.each(n.search(a),function(c,b){if(h&&(!d.filter_selected||!f.children('option[value="'+b.key+'"]').hasClass("selected"))){var e=l,g='<li rel="'+b.key+'">',j=b.value,k=d.filter_begin?"<em>$1</em>$2":"$1<em>$2</em>$3",m=(d.filter_begin?"":"(.*)")+(d.filter_case?"("+a+")(.*)":"("+a.toLowerCase()+")(.*)");try{j=j.replace(RegExp(m,
    d.filter_case?"g":"gi"),k)}catch(n){}l=e+(g+p(j)+"</li>");u++;h--}});g.append(l);d.firstselected&&(j=g.children("li:visible:first"),j.addClass("auto-focus"));u>d.height?g.css({height:24*d.height+"px",overflow:"auto"}):g.css("height","auto");q()&&k.is(":hidden")&&k.show()}function I(){g.children("li").mouseover(function(){g.children("li").removeClass("auto-focus");j=e(this);j.addClass("auto-focus")});g.children("li").mouseout(function(){e(this).removeClass("auto-focus");j=null})}function C(){var a=
    e("#"+r+"_annoninput").children(".maininput");I();g.children("li").unbind("mousedown").mousedown(function(){var a=e(this);m(a.text(),a.attr("rel"),0,0,1);t(1);k.hide()});a.unbind("keydown");a.keydown(function(a){a.keyCode!=h.backspace&&l.children("li.bit-box.deleted").removeClass("deleted");if((a.keyCode==h.enter||a.keyCode==h.tab||a.keyCode==h.comma)&&!(null==j||0==j.length)){var b=j;m(b.text(),b.attr("rel"),0,0,1);return D(a)}if((a.keyCode==h.enter||a.keyCode==h.tab||a.keyCode==h.comma)&&(null==
    j||0==j.length)){if(d.newel)return b=s(e(this).val()),m(b,b,0,0,1),D(a);if((d.addontab||d.addoncomma)&&d.newel)return b=j=g.children("li:visible:first"),m(b.text(),b.attr("rel"),0,0,1),D(a)}a.keyCode==h.downarrow&&J("first");a.keyCode==h.uparrow&&J("last")})}function J(a){g.unbind("mouseover").unbind("mouseout").mousemove(function(){I();g.unbind("mousemove")});if(null==j||0==j.length)j=g.children("li:visible:"+a),g.get(0).scrollTop="first"==a?0:parseInt(j.get(0).scrollHeight,10)*(parseInt(g.children("li:visible").length,
    10)-Math.round(d.height/2));else{j.removeClass("auto-focus");j="first"==a?j.nextAll("li:visible:first"):j.prevAll("li:visible:first");var c=parseInt(j.prevAll("li:visible").length,10),b=parseInt(j.nextAll("li:visible").length,10);if((("first"==a?c:b)>Math.round(d.height/2)||("first"==a?c:b)<=Math.round(d.height/2))&&"undefined"!=typeof j.get(0))g.get(0).scrollTop=parseInt(j.get(0).scrollHeight,10)*(c-Math.round(d.height/2))}g.children("li").removeClass("auto-focus");j.addClass("auto-focus")}function D(a){k.hide();
    a.preventDefault();j=null;return!1}function q(){return 0!=d.maxitems&&l.children("li.bit-box").length<d.maxitems}function x(a,c){var b={};for(i=0;i<c.get(0).attributes.length;i++)null!=c.get(0).attributes[i].nodeValue&&(b["_"+c.get(0).attributes[i].nodeName]=c.get(0).attributes[i].nodeValue);return a.call(a,b)}function s(a,c){if("undefined"!=typeof c){for(i=0;i<a.length;i++){var b=a.charCodeAt(i);if(h.exclamation<=b&&b<=h.slash||h.colon<=b&&b<=h.at||h.squarebricket_left<=b&&b<=h.apostrof)a=a.replace(a[i],
    escape(a[i]))}a=a.replace(/(\{|\}|\*)/i,"\\$1")}return a.replace(/script(.*)/g,"")}function p(a,c){a=a.toString();a=a.replace("\\","");return"undefined"!=typeof c?a:unescape(a)}function t(a){g.children().remove();a&&g.hide()}function H(a){u=0;if(d.json_url&&q())if(d.cache&&E.get(a))B(a),C();else{F++;var c=F;setTimeout(function(){c==F&&e.getJSON(d.json_url,{tag:p(a)},function(b){z&&(B(a,b),E.set(a,1),C())})},d.delay)}else B(a),C()}var d=e.extend({json_url:null,width:512,cache:!1,height:"10",newel:!1,
    addontab:!1,addoncomma:!1,firstselected:!1,filter_case:!1,filter_selected:!1,filter_begin:!1,complete_text:"Start to type...",select_all_text:null,maxshownitems:30,maxitems:10,oncreate:null,onselect:null,onremove:null,attachto:null,delay:350,input_tabindex:0,input_min_size:1,input_name:"",bricket:!0},K),l=null,g=null,k=null,u=0,z=!1,j=null,y=0,A=1,f=e(this),r=f.attr("id"),F=0,E={set:function(a,c){var b=f.data("jsoncache");b[a]=c;f.data("jsoncache",b)},get:function(a){return"undefined"!=f.data("jsoncache")[a]?
    f.data("jsoncache")[a]:null},init:function(){f.data("jsoncache",{})}},h={enter:13,tab:9,comma:188,backspace:8,leftarrow:37,uparrow:38,rightarrow:39,downarrow:40,exclamation:33,slash:47,colon:58,at:64,squarebricket_left:91,apostrof:96},n={search:function(a){var c=[],b=RegExp((d.filter_begin?"^":"")+a,d.filter_case?"g":"gi");e.each(f.data("cache"),function(a,d){"function"===typeof d.search&&-1!=d.search(b)&&c.push({key:a,value:d})});return c},set:function(a,c){var b=f.data("cache");b[a]=c;f.data("cache",
    b)},get:function(a){return"undefined"!=f.data("cache")[a]?f.data("cache")[a]:null},clear:function(){f.data("cache",{})},length:function(){if("object"==typeof f.data("cache")){var a=0;for(i in f.data("cache"))a++;return a}return f.data("cache").length},init:function(){"undefined"==f.data("cache")&&f.data("cache",{})}},l=e('<ul class="holder"></ul>').width(d.width);d.attachto?"object"==typeof d.attachto?d.attachto.append(l):e(d.attachto).append(l):f.after(l);k=e('<div class="facebook-auto">').width(d.width);
    ""!=d.complete_text&&(k.append('<div class="default">'+d.complete_text+"</div>"),d.select_all_text&&k.children(".default").append(e('<a href="" class="select_all_items">'+d.select_all_text+"</a>").click(function(){e(f).trigger("selectAll");return!1})));k.hover(function(){A=0},function(){A=1});g=e('<ul id="'+r+'_feed"></ul>').width(d.width);l.after(k.prepend(g));name=f.attr("name");d.bricket&&"undefined"!=typeof name&&-1==name.indexOf("[]")&&(name+="[]");var v=e("<"+f.get(0).tagName+' name="'+name+
        '" id="'+r+'" multiple="multiple" class="'+f.get(0).className+' hidden">').data("cache",{});e.each(f.children("option"),function(a,c){c=e(c);v.data("cache")[c.val()]=c.text();if(c.hasClass("selected")){var b=m(c.text(),c.val(),!0,c.hasClass("locked"));v.append('<option value="'+c.val()+'" selected="selected" id="opt_'+b+'"class="selected">'+c.text()+"</option>")}});f.after(v);f.remove();f=v;e(f).bind("addItem",function(a,c){m(c.title,c.value,0,0,0)});e(f).bind("removeItem",function(a,c){var b=l.children("li[rel="+
        c.value+"]");b.length&&w(b)});e(f).bind("destroy",function(){l.remove();k.remove();f.show()});e(f).bind("selectAll",function(){var a=e(f).val()||[];e.each(e(f).data("cache"),function(c,b){-1===e.inArray(c,a)&&m(b,c,0,0,0)});g.parent().hide()});G(0);E.init();n.init();return this})}})(jQuery);
